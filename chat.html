<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø­Ø§Ø¯Ø«Ø©</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#ece5dd}
.header{background:#075e54;color:#fff;padding:10px;display:flex;justify-content:space-between}
#chat{padding:10px;height:70vh;overflow-y:auto}
.msg{max-width:75%;padding:8px;margin:6px 0;border-radius:8px}
.me{background:#dcf8c6;margin-left:auto}
.other{background:#fff}
.name{font-size:11px;color:#555}
.time{font-size:10px;color:#666;margin-top:4px}
.footer{display:flex;gap:5px;padding:8px;background:#f0f0f0}
.footer input{flex:1;padding:8px;border-radius:20px;border:1px solid #ccc}
button{border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
.red{background:#b00020}
.green{background:#075e54}
.actions{display:flex;gap:5px;margin-top:5px}
.status{font-size:11px;color:#555;text-align:left}
img{max-width:100%;border-radius:6px}
</style>
</head>

<body>

<div class="header">
  <div>Ù…Ø­Ø§Ø¯Ø«Ø©</div>
  <button class="red" onclick="clearAll()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
</div>

<div id="chat"></div>

<div class="footer">
  <input type="file" id="imgInput" hidden accept="image/*">
  <button class="green" onclick="imgInput.click()">ğŸ–¼ï¸</button>
  <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
  <button class="green" onclick="sendText()">â¤</button>
  <button id="recBtn">ğŸ™ï¸</button>
</div>

<script>
const myName = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ");

/* Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyC3T6PvAihbgMFvxsW4eC1WYwhQ_33tAJw",
  authDomain: "chat-bcdc8.firebaseapp.com",
  projectId: "chat-bcdc8",
  storageBucket: "chat-bcdc8.firebasestorage.app",
});

const db = firebase.firestore();
const storage = firebase.storage();

/* Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
db.collection("chat").orderBy("time").onSnapshot(snap=>{
  chat.innerHTML="";
  const hidden = JSON.parse(localStorage.getItem("hiddenMsgs")||"[]");

  snap.forEach(doc=>{
    if(hidden.includes(doc.id)) return;

    const d = doc.data();
    const isMe = d.name === myName;
    const side = isMe ? "me" : "other";
    const t = new Date(d.time).toLocaleTimeString("ar-BH");
    const deleted = d.deletedForAll === true;

    /* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© */
    if(!isMe && !deleted && (!d.readBy || !d.readBy.includes(myName))){
      db.collection("chat").doc(doc.id).update({
        readBy: firebase.firestore.FieldValue.arrayUnion(myName)
      });
    }

    let status = "";
    if(isMe && !deleted){
      if(d.readBy && d.readBy.length > 0){
        status = "âœ”âœ”ï¸ ØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©";
      }else{
        status = "âœ”ï¸ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
      }
    }

    chat.innerHTML += `
    <div class="msg ${side}">
      <div class="name">${d.name}</div>

      ${deleted
        ? `<div style="color:#777;font-style:italic">ğŸš« ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>`
        : `
          <div>${d.text || ""}</div>
          ${d.img ? `<img src="${d.img}">` : ""}
          ${d.audio ? `<audio controls src="${d.audio}"></audio>` : ""}
        `
      }

      <div class="time">${t}</div>
      ${isMe ? `<div class="status">${status}</div>` : ""}

      ${isMe && !deleted ? `
      <div class="actions">
        <button class="red" onclick="deleteForMe('${doc.id}')">Ø­Ø°Ù Ø¹Ù†Ø¯ÙŠ</button>
        <button class="red" onclick="deleteForAll('${doc.id}')">Ø­Ø°Ù Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹</button>
      </div>` : ""}
    </div>`;
  });

  chat.scrollTop = chat.scrollHeight;
});

/* Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ */
function sendText(){
  const text = msgInput.value.trim();
  if(!text) return;

  db.collection("chat").add({
    name: myName,
    text: text,
    time: Date.now(),
    sent: true,
    readBy: []
  });

  msgInput.value="";
}

/* Ø­Ø°Ù Ø¹Ù†Ø¯ÙŠ ÙÙ‚Ø· */
function deleteForMe(id){
  const h = JSON.parse(localStorage.getItem("hiddenMsgs") || "[]");
  if(!h.includes(id)){
    h.push(id);
    localStorage.setItem("hiddenMsgs", JSON.stringify(h));
  }
}

/* Ø­Ø°Ù Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹ */
function deleteForAll(id){
  db.collection("chat").doc(id).update({
    deletedForAll: true,
    text: "",
    img: "",
    audio: ""
  });
}

/* ØµÙˆØ±Ø© */
imgInput.onchange = ()=>{
  const f = imgInput.files[0];
  if(!f) return;
  const ref = storage.ref("imgs/"+Date.now());
  ref.put(f).then(()=>ref.getDownloadURL().then(url=>{
    db.collection("chat").add({
      name: myName,
      img: url,
      time: Date.now(),
      sent: true,
      readBy: []
    });
  }));
  imgInput.value="";
};

/* ØµÙˆØª */
let rec=null, stream=null, chunks=[];
recBtn.onclick = async ()=>{
  if(!rec){
    stream = await navigator.mediaDevices.getUserMedia({audio:true});
    rec = new MediaRecorder(stream);
    rec.ondataavailable = e => chunks.push(e.data);
    rec.start();
    recBtn.innerText="â¹ï¸";
  }else{
    rec.stop();
    recBtn.innerText="ğŸ™ï¸";
    rec.onstop = ()=>{
      const blob = new Blob(chunks,{type:"audio/mp4"});
      chunks=[];
      const ref = storage.ref("audio/"+Date.now());
      ref.put(blob).then(()=>ref.getDownloadURL().then(url=>{
        db.collection("chat").add({
          name: myName,
          audio: url,
          time: Date.now(),
          sent: true,
          readBy: []
        });
      }));
    };
    rec=null;
  }
};

/* Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ */
function clearAll(){
  db.collection("chat").get().then(s=>s.forEach(d=>d.ref.delete()));
}
</script>

</body>
</html>
