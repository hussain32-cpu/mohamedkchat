<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WhatsApp Pro + Voice</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
:root { --primary: #075e54; --accent: #25d366; --bg: #e5ddd5; --me: #dcf8c6; --other: #fff; --read: #34b7f1; }
body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: fixed; width: 100%; }

.header { background: var(--primary); color: #fff; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; height: 55px; z-index: 10; }
.header-right { display: flex; align-items: center; gap: 12px; }

#chat { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }

.msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; position: relative; font-size: 15px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
.msg.me { align-self: flex-start; background: var(--me); border-top-right-radius: 2px; }
.msg.other { align-self: flex-end; background: var(--other); border-top-left-radius: 2px; }

.time { font-size: 10px; color: #888; display: flex; justify-content: flex-end; align-items: center; gap: 3px; margin-top: 4px; }
.read-tick { color: #888; font-size: 14px; }
.is-read { color: var(--read); }

/* Ø§Ù„ÙÙˆØªØ± ÙˆØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
.footer { background: #f0f0f0; padding: 10px; position: relative; }
.footer-main { display: flex; gap: 8px; align-items: center; }
.input-box { flex: 1; background: white; border-radius: 25px; display: flex; padding: 5px 15px; align-items: center; border: 1px solid #ddd; }
.input-box input { border: none; outline: none; flex: 1; padding: 8px; font-size: 16px; }
.btn-action { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }

/* Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
#voicePreview { display: none; background: #fff; border-radius: 25px; padding: 5px 15px; align-items: center; gap: 10px; flex: 1; border: 1px solid var(--accent); }
#voicePreview audio { height: 30px; flex: 1; }

.recording-blink { color: red; animation: blink 1s infinite; font-weight: bold; margin-right: 10px; }
@keyframes blink { 50% { opacity: 0; } }

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„ */
#callOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(7, 94, 84, 0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
.btn-hangup { background: #ff3b30; color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 18px; cursor: pointer; margin-top: 50px; }

audio.msg-audio { width: 100%; max-width: 250px; margin-top: 5px; }
img.msg-img { max-width: 100%; border-radius: 8px; margin-top: 5px; }
</style>
</head>
<body id="appBody">

<audio id="sendSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
<audio id="receiveSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
<audio id="ringtone" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>

<div id="callOverlay">
    <div style="font-size: 60px; margin-bottom: 20px;">ğŸ“</div>
    <h2 id="callerName">...</h2>
    <p>Ø§ØªØµØ§Ù„ ÙˆØ§Ø±Ø¯</p>
    <button class="btn-hangup" onclick="stopRinging()">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<div class="header">
    <div class="header-right">
        <span onclick="changeName()" style="cursor:pointer; font-weight:bold;">ğŸ‘¤ <span id="userLabel">...</span></span>
    </div>
    <div style="display:flex; align-items:center; gap:18px;">
        <span onclick="startCall()" style="cursor:pointer; font-size: 20px;">ğŸ“</span>
        <span class="ghost-btn" onclick="enterAdmin()" style="cursor:pointer; font-size: 20px;">ğŸ‘»</span>
        <button style="background:none; border:none; color:white; font-size: 18px;" onclick="clearLocal()">ğŸ—‘ï¸</button>
    </div>
</div>

<div id="chat"></div>

<div class="footer">
    <div class="footer-main">
        <div id="normalInput" class="input-box" style="display: flex;">
            <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="if(event.key==='Enter') sendMsg()">
            <label for="imgUpload" style="cursor:pointer; font-size: 20px; margin-right: 10px;">ğŸ–¼ï¸</label>
            <input type="file" id="imgUpload" hidden accept="image/*">
        </div>

        <div id="voicePreview">
            <span class="recording-blink" id="recStatus">â—</span>
            <audio id="audioPreview" controls></audio>
            <button onclick="cancelVoice()" style="background:none; border:none; color:red; font-size: 18px;">ğŸ—‘ï¸</button>
        </div>

        <button id="sendBtn" class="btn-action" onclick="sendMsg()">â¤</button>
        <button id="micBtn" class="btn-action" onclick="toggleRecording()">ğŸ™ï¸</button>
    </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC3T6PvAihbgMFvxsW4eC1WYwhQ_33tAJw",
  authDomain: "chat-bcdc8.firebaseapp.com",
  projectId: "chat-bcdc8",
  storageBucket: "chat-bcdc8.firebasestorage.app",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

let myName = localStorage.getItem("chatName") || "Ù…Ø³ØªØ®Ø¯Ù…";
let isInitialLoad = true;
let mediaRecorder;
let audioChunks = [];
let audioBlob;
let isRecording = false;

document.getElementById("userLabel").innerText = myName;

// --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ ---
async function toggleRecording() {
    if (!isRecording) {
        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
            const audioUrl = URL.createObjectURL(audioBlob);
            document.getElementById("audioPreview").src = audioUrl;
            document.getElementById("recStatus").innerText = "Ù…Ø¹Ø§ÙŠÙ†Ø©";
            document.getElementById("recStatus").classList.remove("recording-blink");
        };

        mediaRecorder.start();
        isRecording = true;
        document.getElementById("normalInput").style.display = "none";
        document.getElementById("sendBtn").style.display = "none";
        document.getElementById("voicePreview").style.display = "flex";
        document.getElementById("micBtn").innerHTML = "â¹ï¸"; // Ø²Ø± Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
        document.getElementById("recStatus").innerText = "ØªØ³Ø¬ÙŠÙ„...";
        document.getElementById("recStatus").classList.add("recording-blink");
    } else {
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        mediaRecorder.stop();
        isRecording = false;
        document.getElementById("micBtn").style.display = "none";
        document.getElementById("sendBtn").style.display = "flex"; // ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†
    }
}

function cancelVoice() {
    document.getElementById("voicePreview").style.display = "none";
    document.getElementById("normalInput").style.display = "flex";
    document.getElementById("micBtn").style.display = "flex";
    document.getElementById("micBtn").innerHTML = "ğŸ™ï¸";
    document.getElementById("sendBtn").style.display = "flex";
    audioBlob = null;
}

// --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ù†Øµ Ø£Ùˆ ØµÙˆØª) ---
async function sendMsg() {
    const input = document.getElementById("msgInput");
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØµÙˆØª Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    if (audioBlob) {
        const ref = storage.ref("voice/" + Date.now() + ".mp3");
        await ref.put(audioBlob);
        const url = await ref.getDownloadURL();
        db.collection("chat").add({ name: myName, voice: url, time: Date.now(), readBy: [] });
        cancelVoice();
        document.getElementById("sendSound").play().catch(e => {});
        return;
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ Ø¹Ø§Ø¯ÙŠ
    if(!input.value.trim()) return;
    db.collection("chat").add({ name: myName, text: input.value, time: Date.now(), readBy: [] });
    document.getElementById("sendSound").play().catch(e => {});
    input.value = "";
}

// --- Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
db.collection("chat").orderBy("time").onSnapshot(snap => {
    const chatBox = document.getElementById("chat");
    chatBox.innerHTML = "";
    snap.forEach(doc => {
        const d = doc.data();
        const isMe = d.name === myName;
        const side = isMe ? "me" : "other";
        const t = new Date(d.time).toLocaleTimeString("ar-BH", {hour:'2-digit', minute:'2-digit'});
        
        let content = d.text ? `<div>${d.text}</div>` : "";
        if(d.img) content += `<img src="${d.img}" class="msg-img">`;
        if(d.voice) content += `<audio controls class="msg-audio" src="${d.voice}"></audio>`;

        let tickClass = (d.readBy && d.readBy.length > 0) ? "is-read" : "";
        chatBox.innerHTML += `
        <div class="msg ${side}">
            <div style="font-size:11px; color:var(--primary); font-weight:bold">${d.name}</div>
            ${content}
            <div class="time">${t} ${isMe ? `<span class="read-tick ${tickClass}">âœ”ï¸âœ”ï¸</span>` : ""}</div>
        </div>`;
    });
    
    if (!isInitialLoad) {
        let last = snap.docChanges()[snap.docChanges().length-1];
        if(last && last.type === "added" && last.doc.data().name !== myName) {
            document.getElementById("receiveSound").play().catch(e => {});
        }
    }
    isInitialLoad = false;
    chatBox.scrollTop = chatBox.scrollHeight;
});

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø§Ù„Ø´Ø¨Ø­ØŒ Ø§Ù„Ø®) ---
function startCall() {
    if(confirm("Ø±Ù†ÙŠÙ† Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±ØŸ")) db.collection("calls").add({ from: myName, time: Date.now() });
}
db.collection("calls").orderBy("time", "desc").limit(1).onSnapshot(snap => {
    snap.forEach(doc => {
        if(doc.data().from !== myName && (Date.now() - doc.data().time < 10000)) {
            document.getElementById("callerName").innerText = doc.data().from;
            document.getElementById("callOverlay").style.display = "flex";
            document.getElementById("ringtone").play().catch(e => {});
        }
    });
});
function stopRinging() { 
    document.getElementById("callOverlay").style.display = "none"; 
    document.getElementById("ringtone").pause(); 
}
function changeName() {
    let n = prompt("ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…:", myName);
    if(n) { localStorage.setItem("chatName", n); location.reload(); }
}
function enterAdmin() {
    let p = prompt("ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø´Ø¨Ø­:");
    if(p === "123") { document.getElementById("appBody").classList.toggle("admin-active"); alert("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹"); }
}
function clearLocal() {
    if(confirm("Ù…Ø³Ø­ØŸ")) { localStorage.setItem("hidden_msgs", JSON.stringify([])); location.reload(); }
}
imgUpload.onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const ref = storage.ref("imgs/" + Date.now());
    ref.put(file).then(() => ref.getDownloadURL().then(url => {
        db.collection("chat").add({ name: myName, img: url, time: Date.now(), readBy: [] });
    }));
};
</script>
</body>
</html>
