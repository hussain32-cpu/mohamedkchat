<div class="footer">
    <div class="footer-main">
        <div id="normalInput" class="input-box" style="display: flex;">
            <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="if(event.key==='Enter') sendTextOnly()">
            <label for="imgUpload" style="cursor:pointer; font-size: 20px; margin-right: 10px;">ğŸ–¼ï¸</label>
            <input type="file" id="imgUpload" hidden accept="image/*">
        </div>

        <div id="voicePreview" style="display: none; background: #fff; border-radius: 25px; padding: 5px 15px; align-items: center; gap: 10px; flex: 1; border: 1px solid #25d366;">
            <span class="recording-blink" id="recStatus" style="color:red">â— ØªØ³Ø¬ÙŠÙ„</span>
            <audio id="audioPreview" controls style="height: 30px; flex: 1;"></audio>
            <button onclick="cancelVoice()" style="background:none; border:none; color:red; font-size: 18px;">ğŸ—‘ï¸</button>
        </div>

        <button id="sendBtn" class="btn-action" onclick="handleSend()">â¤</button>
        <button id="micBtn" class="btn-action" onclick="toggleRecording()">ğŸ™ï¸</button>
    </div>
</div>

<script>
// Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¶Ø¹Ù‡ Ù‡Ù†Ø§ (Config)
const firebaseConfig = {
  apiKey: "AIzaSyC3T6PvAihbgMFvxsW4eC1WYwhQ_33tAJw",
  authDomain: "chat-bcdc8.firebaseapp.com",
  projectId: "chat-bcdc8",
  storageBucket: "chat-bcdc8.firebasestorage.app",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

let myName = localStorage.getItem("chatName") || "Ù…Ø³ØªØ®Ø¯Ù…";
let mediaRecorder;
let audioChunks = [];
let audioBlob = null;
let isRecording = false;

// ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠØ©
async function handleSend() {
    // 1. Ø¥Ø°Ø§ ÙÙŠÙ‡ ØµÙˆØª Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    if (audioBlob) {
        await sendVoice();
        return;
    }
    // 2. Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠÙ‡ ØµÙˆØªØŒ Ø£Ø±Ø³Ù„ Ø§Ù„Ù†Øµ
    sendTextOnly();
}

async function sendTextOnly() {
    const input = document.getElementById("msgInput");
    if(!input.value.trim()) return;
    
    try {
        await db.collection("chat").add({
            name: myName,
            text: input.value,
            time: Date.now(),
            readBy: []
        });
        document.getElementById("sendSound").play().catch(e => {});
        input.value = "";
    } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + e.message); }
}

async function toggleRecording() {
    if (!isRecording) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                document.getElementById("audioPreview").src = URL.createObjectURL(audioBlob);
                document.getElementById("recStatus").innerText = "Ø¬Ø§Ù‡Ø²";
                document.getElementById("recStatus").classList.remove("recording-blink");
            };

            mediaRecorder.start();
            isRecording = true;
            document.getElementById("normalInput").style.display = "none";
            document.getElementById("voicePreview").style.display = "flex";
            document.getElementById("micBtn").innerHTML = "â¹ï¸";
            document.getElementById("micBtn").style.background = "red";
        } catch (err) {
            alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­");
        }
    } else {
        mediaRecorder.stop();
        isRecording = false;
        document.getElementById("micBtn").style.display = "none"; // Ù†Ø®ÙÙŠÙ‡ Ø¹Ø´Ø§Ù† ÙŠØ±Ø³Ù„ Ø¨Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø®Ø¶Ø±
        document.getElementById("sendBtn").style.display = "flex";
    }
}

async function sendVoice() {
    if (!audioBlob) return;
    const sendBtn = document.getElementById("sendBtn");
    sendBtn.disabled = true;
    sendBtn.innerText = "...";

    try {
        const ref = storage.ref("voice/" + Date.now() + ".mp3");
        await ref.put(audioBlob);
        const url = await ref.getDownloadURL();
        await db.collection("chat").add({
            name: myName,
            voice: url,
            time: Date.now(),
            readBy: []
        });
        document.getElementById("sendSound").play().catch(e => {});
        cancelVoice();
    } catch (e) { alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØª"); }
    
    sendBtn.disabled = false;
    sendBtn.innerText = "â¤";
}

function cancelVoice() {
    audioBlob = null;
    document.getElementById("voicePreview").style.display = "none";
    document.getElementById("normalInput").style.display = "flex";
    document.getElementById("micBtn").style.display = "flex";
    document.getElementById("micBtn").innerHTML = "ğŸ™ï¸";
    document.getElementById("micBtn").style.background = "#075e54";
    document.getElementById("sendBtn").style.display = "flex";
}

// Ø£Ø¶Ù Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (onSnapshot) ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ù†Ø³Ø®ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
</script>
