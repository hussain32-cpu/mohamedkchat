<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
:root {
    --primary: #075e54;
    --secondary: #25d366;
    --bg-chat: #e5ddd5;
    --msg-me: #dcf8c6;
    --msg-other: #ffffff;
}

body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-chat); display: flex; flex-direction: column; height: 100vh; }

.header { background: var(--primary); color: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }

#chat { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; }

.msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; position: relative; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
.me { background: var(--msg-me); align-self: flex-start; border-top-right-radius: 2px; }
.other { background: var(--msg-other); align-self: flex-end; border-top-left-radius: 2px; }

.name { font-size: 12px; font-weight: bold; color: var(--primary); margin-bottom: 4px; }
.time { font-size: 10px; color: #888; text-align: left; margin-top: 5px; }

.footer { display: flex; gap: 10px; padding: 12px; background: #f0f0f0; align-items: center; }
.footer input { flex: 1; padding: 12px; border-radius: 25px; border: none; outline: none; }
.btn-action { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }

img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
audio { margin-top: 5px; height: 35px; width: 200px; }
.btn-delete { background: #ff4d4d; color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 5px; }
</style>
</head>
<body>

<div class="header">
    <div onclick="changeName()" style="cursor:pointer">ğŸ‘¤ <span id="currentUserName">ØªØ­Ù…ÙŠÙ„...</span></div>
    <button style="background:transparent; border:1px solid #fff; color:white; padding:5px; border-radius:5px;" onclick="clearAll()">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
</div>

<div id="chat"></div>

<audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

<div class="footer">
    <input type="file" id="imgInput" hidden accept="image/*">
    <button class="btn-action" onclick="imgInput.click()">ğŸ–¼ï¸</button>
    <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="if(event.key==='Enter') sendText()">
    <button id="recBtn" class="btn-action">ğŸ™ï¸</button>
    <button class="btn-action" onclick="sendText()">â¤</button>
</div>

<script>
/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ - ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù‡Ù†Ø§ */
const firebaseConfig = {
  apiKey: "AIzaSyC3T6PvAihbgMFvxsW4eC1WYwhQ_33tAJw",
  authDomain: "chat-bcdc8.firebaseapp.com",
  projectId: "chat-bcdc8",
  storageBucket: "chat-bcdc8.firebasestorage.app",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

let myName = localStorage.getItem("chatName") || prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ") || "Ø²Ø§Ø¦Ø±";
localStorage.setItem("chatName", myName);
document.getElementById("currentUserName").innerText = myName;

let lastMsgTime = Date.now();

// ÙˆØ¸ÙŠÙØ© ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
function changeName() {
    let newName = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", myName);
    if(newName) {
        myName = newName;
        localStorage.setItem("chatName", myName);
        document.getElementById("currentUserName").innerText = myName;
    }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØµÙˆØª
db.collection("chat").orderBy("time").onSnapshot(snap => {
    const chatDiv = document.getElementById("chat");
    chatDiv.innerHTML = "";
    let hasNew = false;

    snap.forEach(doc => {
        const d = doc.data();
        if(d.time > lastMsgTime) hasNew = true;

        const isMe = d.name === myName;
        const side = isMe ? "me" : "other";
        const t = new Date(d.time).toLocaleTimeString("ar-BH", {hour:'2-digit', minute:'2-digit'});
        const deleted = d.deletedForAll === true;

        chatDiv.innerHTML += `
        <div class="msg ${side}">
            <div class="name">${d.name}</div>
            ${deleted ? `<div style="color:#999; font-style:italic">ğŸš« ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>` : `
                <div>${d.text || ""}</div>
                ${d.img ? `<img src="${d.img}">` : ""}
                ${d.audio ? `<audio controls src="${d.audio}"></audio>` : ""}
            `}
            <div class="time">${t}</div>
            ${isMe && !deleted ? `<button class="btn-delete" onclick="deleteForAll('${doc.id}')">Ø­Ø°Ù Ù„Ù„Ø¬Ù…ÙŠØ¹</button>` : ""}
        </div>`;
    });

    if(hasNew) {
        document.getElementById("notifSound").play().catch(()=>{});
        lastMsgTime = Date.now();
    }
    chatDiv.scrollTop = chatDiv.scrollHeight;
});

function sendText(){
    const input = document.getElementById("msgInput");
    if(!input.value.trim()) return;
    db.collection("chat").add({ name: myName, text: input.value, time: Date.now() });
    input.value = "";
}

function deleteForAll(id){
    if(confirm("Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) db.collection("chat").doc(id).update({ deletedForAll: true, text: "", img: "", audio: "" });
}

function clearAll(){
    if(confirm("Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ")) db.collection("chat").get().then(s => s.forEach(d => d.ref.delete()));
}

// Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
document.getElementById("imgInput").onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const ref = storage.ref("imgs/" + Date.now());
    ref.put(file).then(() => ref.getDownloadURL().then(url => {
        db.collection("chat").add({ name: myName, img: url, time: Date.now() });
    })).catch(() => alert("ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Storage Rules"));
};

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª
let rec=null, chunks=[];
document.getElementById("recBtn").onclick = async () => {
    if(!rec){
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        rec = new MediaRecorder(stream);
        rec.ondataavailable = e => chunks.push(e.data);
        rec.start();
        document.getElementById("recBtn").innerText = "â¹ï¸";
    } else {
        rec.stop();
        document.getElementById("recBtn").innerText = "ğŸ™ï¸";
        rec.onstop = () => {
            const blob = new Blob(chunks, {type: "audio/mp4"});
            chunks = [];
            const ref = storage.ref("audio/" + Date.now());
            ref.put(blob).then(() => ref.getDownloadURL().then(url => {
                db.collection("chat").add({ name: myName, audio: url, time: Date.now() });
            }));
        };
        rec = null;
    }
};
</script>
</body>
</html>
