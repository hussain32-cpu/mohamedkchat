<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ØªØ·ÙˆØ±Ø©</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
:root { --primary: #075e54; --secondary: #128c7e; --bg: #e5ddd5; --me: #dcf8c6; --other: #fff; }
body { margin: 0; font-family: sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; }

/* Ø§Ù„Ù‡ÙŠØ¯Ø± */
.header { background: var(--primary); color: #fff; padding: 12px; display: flex; justify-content: space-between; align-items: center; }

/* Ø§Ù„Ø´Ø§Øª */
#chat { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }

/* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.msg { max-width: 75%; padding: 8px 12px; border-radius: 12px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); font-size: 15px; }
.msg.me { align-self: flex-start; background: var(--me); border-top-right-radius: 2px; }
.msg.other { align-self: flex-end; background: var(--other); border-top-left-radius: 2px; }

.name { font-size: 11px; font-weight: bold; color: var(--secondary); margin-bottom: 3px; }
.time { font-size: 10px; color: #888; display: flex; align-items: center; justify-content: flex-end; gap: 3px; }
.ticks { font-size: 14px; line-height: 1; }
.read { color: #34b7f1; } /* Ù„ÙˆÙ† Ø§Ù„ØµØ­ÙŠÙ† Ø£Ø²Ø±Ù‚ */

/* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
.emoji-picker { display: none; position: absolute; bottom: 60px; right: 10px; background: white; border: 1px solid #ccc; padding: 5px; border-radius: 10px; grid-template-columns: repeat(5, 1fr); gap: 5px; z-index: 100; }
.emoji-picker span { cursor: pointer; font-size: 20px; padding: 5px; }

/* Ø§Ù„ÙÙˆØªØ± */
.footer { display: flex; gap: 8px; padding: 10px; background: #f0f0f0; align-items: center; position: relative; }
.footer input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }
.btn { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }

.edit-btn { background: none; border: none; color: #555; font-size: 10px; cursor: pointer; margin-right: 5px; text-decoration: underline; }
img { max-width: 100%; border-radius: 8px; }
</style>
</head>
<body>

<div class="header">
    <div onclick="changeName()" style="cursor:pointer">ğŸ‘¤ <span id="currentUserName">...</span></div>
    <button style="background:none; border:1px solid #fff; color:#fff; border-radius:5px;" onclick="clearAll()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
</div>

<div id="chat"></div>

<div id="emojiPicker" class="emoji-picker">
    <span onclick="addEmoji('ğŸ˜‚')">ğŸ˜‚</span> <span onclick="addEmoji('â¤ï¸')">â¤ï¸</span>
    <span onclick="addEmoji('ğŸ‘')">ğŸ‘</span> <span onclick="addEmoji('ğŸ˜')">ğŸ˜</span>
    <span onclick="addEmoji('ğŸ™')">ğŸ™</span> <span onclick="addEmoji('ğŸ”¥')">ğŸ”¥</span>
    <span onclick="addEmoji('ğŸ˜­')">ğŸ˜­</span> <span onclick="addEmoji('ğŸ¤”')">ğŸ¤”</span>
    <span onclick="addEmoji('ğŸ˜Š')">ğŸ˜Š</span> <span onclick="addEmoji('âœ…')">âœ…</span>
</div>

<div class="footer">
    <button class="btn" onclick="toggleEmoji()">ğŸ˜Š</button>
    <input type="file" id="imgInput" hidden accept="image/*">
    <button class="btn" onclick="imgInput.click()">ğŸ–¼ï¸</button>
    <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
    <button class="btn" onclick="sendText()">â¤</button>
</div>

<audio id="notif" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC3T6PvAihbgMFvxsW4eC1WYwhQ_33tAJw",
  authDomain: "chat-bcdc8.firebaseapp.com",
  projectId: "chat-bcdc8",
  storageBucket: "chat-bcdc8.firebasestorage.app",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

let myName = localStorage.getItem("chatName") || prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ") || "Ø²Ø§Ø¦Ø±";
localStorage.setItem("chatName", myName);
document.getElementById("currentUserName").innerText = myName;

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ
function sendText(){
    const val = msgInput.value.trim();
    if(!val) return;
    db.collection("chat").add({ name: myName, text: val, time: Date.now(), readBy: [] });
    msgInput.value = "";
    emojiPicker.style.display = "none";
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„ØµØ­ ÙˆØµØ­ÙŠÙ†
db.collection("chat").orderBy("time").onSnapshot(snap => {
    chat.innerHTML = "";
    snap.forEach(doc => {
        const d = doc.data();
        const isMe = d.name === myName;
        const side = isMe ? "me" : "other";
        const t = new Date(d.time).toLocaleTimeString("ar-BH", {hour:'2-digit', minute:'2-digit'});
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
        if(!isMe && (!d.readBy || !d.readBy.includes(myName))) {
            db.collection("chat").doc(doc.id).update({ readBy: firebase.firestore.FieldValue.arrayUnion(myName) });
        }

        // Ø´ÙƒÙ„ Ø§Ù„ØµØ­ÙŠÙ†
        let ticks = "âœ”ï¸"; 
        let ticksClass = "";
        if(isMe) {
            if(d.readBy && d.readBy.length > 0) {
                ticks = "âœ”ï¸âœ”ï¸"; 
                ticksClass = "read"; // Ø£Ø²Ø±Ù‚
            }
        }

        chat.innerHTML += `
        <div class="msg ${side}">
            <div class="name">${d.name}</div>
            <div>${d.text || ""} ${d.edited ? '<small style="color:#888">(Ù…Ø¹Ø¯Ù„Ø©)</small>' : ''}</div>
            ${d.img ? `<img src="${d.img}">` : ""}
            <div class="time">
                ${t} <span class="ticks ${ticksClass}">${isMe ? ticks : ""}</span>
            </div>
            ${isMe ? `<button class="edit-btn" onclick="editMsg('${doc.id}', '${d.text}')">ØªØ¹Ø¯ÙŠÙ„</button>` : ""}
        </div>`;
    });
    chat.scrollTop = chat.scrollHeight;
});

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
function editMsg(id, oldText) {
    const newText = prompt("Ø¹Ø¯Ù„ Ø±Ø³Ø§Ù„ØªÙƒ:", oldText);
    if(newText && newText !== oldText) {
        db.collection("chat").doc(id).update({ text: newText, edited: true });
    }
}

// Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
function toggleEmoji() { emojiPicker.style.display = emojiPicker.style.display === "grid" ? "none" : "grid"; }
function addEmoji(e) { msgInput.value += e; msgInput.focus(); }

function changeName() {
    let n = prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", myName);
    if(n) { myName = n; localStorage.setItem("chatName", n); location.reload(); }
}

function clearAll() { if(confirm("Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ")) db.collection("chat").get().then(s => s.forEach(d => d.ref.delete())); }

// Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
imgInput.onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const ref = storage.ref("imgs/" + Date.now());
    ref.put(file).then(() => ref.getDownloadURL().then(url => {
        db.collection("chat").add({ name: myName, img: url, time: Date.now(), readBy: [] });
    }));
};
</script>
</body>
</html>
